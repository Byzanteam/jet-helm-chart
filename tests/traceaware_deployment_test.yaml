suite: test traceAware deployment
templates:
  - templates/trace-aware/deployment.yaml
tests:
  - it: should render deployment resource
    asserts:
      - isKind:
          of: Deployment

  - it: should set name label, if nameOverride no override is set
    asserts:
      - isSubset:
          path: spec.selector
          content:
            matchLabels:
              app.kubernetes.io/name: jet-helm-chart
              app.kubernetes.io/instance: RELEASE-NAME
              app.kubernetes.io/application: trace-aware

  - it: should set name label, if set nameOverride
    set:
      nameOverride: unittest
    asserts:
      - isSubset:
          path: spec.selector
          content:
            matchLabels:
              app.kubernetes.io/name: unittest
              app.kubernetes.io/instance: RELEASE-NAME
              app.kubernetes.io/application: trace-aware

  - it: should change image when image value is specified
    values:
      - ./values/test.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: registry.cn-hangzhou.aliyuncs.com/org/traceAware:latest

  - it: should use exist image pull secret when set
    set:
      image:
        existingImageSecret: docker-registry-secret  
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: docker-registry-secret

  - it: render containers env
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[0].name
          value: CREDENTIAL_SECRET
      - isSubset: 
          path: spec.template.spec.containers[0].env[0].valueFrom
          content:
            secretKeyRef:
              name: jet-env-secret
              key: credential_secret
      - equal:
          path: spec.template.spec.containers[0].env[1].name
          value: JET_JWT_PRIVATE_KEY
      - isSubset: 
          path: spec.template.spec.containers[0].env[1].valueFrom
          content:
            secretKeyRef:
              name: jet-env-secret
              key: jet_jwt_private_key
      - equal:
          path: spec.template.spec.containers[0].env[2].name
          value: SECRET_KEY_BASE
      - isSubset: 
          path: spec.template.spec.containers[0].env[2].valueFrom
          content:
            secretKeyRef:
              name: jet-env-secret
              key: secret_key_base
      - equal:
          path: spec.template.spec.containers[0].env[3].name
          value: TRACE_AWARE_DATABASE_URL
      - isSubset: 
          path: spec.template.spec.containers[0].env[3].valueFrom
          content:
            secretKeyRef:
              name: jet-env-secret
              key: trace_aware_database_url
      - equal:
          path: spec.template.spec.containers[0].env[4].name
          value: PROJECT_MAN_DATABASE_URL
      - isSubset: 
          path: spec.template.spec.containers[0].env[4].valueFrom
          content:
            secretKeyRef:
              name: jet-env-secret
              key: project_man_database_url
      - equal:
          path: spec.template.spec.containers[0].env[5].name
          value: DYNAMIC_REPO_PASSWORD
      - isSubset: 
          path: spec.template.spec.containers[0].env[5].valueFrom
          content:
            secretKeyRef:
              name: jet-env-secret
              key: dynamicdb-password
